<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Context API — Core Demo</title>
    <link rel="stylesheet" href="@nonoun/native-ui/css/foundation" />
    <link rel="stylesheet" href="@nonoun/native-ui/css/components" />
    <style>
      main { padding: 2rem; }
      h1 { font-size: 1.25rem; font-weight: 700; margin-bottom: 0.25rem; }
      .subtitle { color: var(--neutral-ink-muted); font-size: 0.8125rem; margin-bottom: 1.5rem; white-space: normal; }

      /* Structural wrappers: display contents so they don't create boxes */
      session-provider, notif-provider {
        display: contents;
      }
      /* Content elements: block display */
      app-toolbar, team-presence, notif-prefs, notif-panel,
      activity-feed, session-stats, ctx-log {
        display: block;
      }
      notif-panel-actions { display: inline-flex; align-items: center; gap: 0.5rem; }

      /* ── Toolbar chrome ── */
      .avatar-wrap { position: relative; display: inline-flex; }
      .toolbar-info { line-height: 1.3; }
      .toolbar-name { font-size: 0.8125rem; font-weight: 600; }
      .toolbar-role { font-size: 0.6875rem; color: var(--neutral-ink-muted); }
      .notif-bell { position: relative; display: inline-flex; }

      /* ── Presence cards ── */
      .presence-name { font-size: 0.8125rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: left; }
      .presence-role { font-size: 0.6875rem; color: var(--neutral-ink-muted); }

      /* ── Activity items ── */
      .activity-dot {
        flex-shrink: 0; width: 1.75rem; height: 1.75rem;
        border-radius: 50%; display: grid; place-items: center;
      }
      .activity-dot.info    { background: var(--info-surface); color: var(--info-surface-ink); }
      .activity-dot.success { background: var(--success-surface); color: var(--success-surface-ink); }
      .activity-dot.warning { background: var(--warning-surface); color: var(--warning-surface-ink); }
      .activity-dot.danger  { background: var(--danger-surface); color: var(--danger-surface-ink); }
      .activity-dot.accent  { background: var(--accent-surface); color: var(--accent-surface-ink); }
      .activity-text { font-size: 0.8125rem; line-height: 1.4; white-space: normal; }
      .activity-text strong { font-weight: 600; }
      .activity-time { font-size: 0.6875rem; color: var(--neutral-ink-muted); margin-top: 0.125rem; }

      /* ── Notif items ── */
      .notif-text { white-space: normal; overflow-wrap: break-word; }
      .notif-text strong { display: block; font-size: 0.8125rem; font-weight: 600; line-height: 1.4; }
      .notif-text p { margin: 0.125rem 0 0; font-size: 0.75rem; color: var(--neutral-ink-muted); line-height: 1.4; }

      /* ── Stats ── */
      .stat-value { font-size: 1.5rem; font-weight: 700; line-height: 1; font-variant-numeric: tabular-nums; text-align: center; }
      .stat-label { font-size: 0.625rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; color: var(--neutral-ink-muted); text-align: center; }

      /* ── Pref rows ── */
      .pref-label { font-size: 0.8125rem; }
      .pref-desc { font-size: 0.6875rem; color: var(--neutral-ink-muted); margin-top: 0.125rem; white-space: normal; }

      /* ── Context log ── */
      .ctx-log {
        background: var(--neutral-panel); border: 1px solid var(--neutral-border-muted);
        border-radius: 0.375rem; padding: 0.5rem 0.75rem;
        max-height: 10rem; overflow-y: auto;
        font-family: ui-monospace, monospace; font-size: 0.6875rem;
        scrollbar-width: thin; scrollbar-color: var(--neutral-border-muted) transparent;
      }
      .log-entry { padding: 0.125rem 0; color: var(--neutral-ink-muted); border-bottom: 1px solid var(--neutral-border-muted); }
      .log-entry:last-child { border-bottom: none; }
      .log-tag { font-weight: 600; margin-right: 0.25rem; }
      .log-tag.user  { color: var(--accent-ink); }
      .log-tag.notif { color: var(--danger-ink); }
      .log-tag.pref  { color: var(--info-ink); }
      .log-ts { float: right; opacity: 0.5; }

      /* ── Entry animation ── */
      @keyframes fade-slide { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
      .notif-row, .activity-row { animation: fade-slide 200ms ease-out; }
    </style>
  </head>
  <body>
    <ui-layout>
      <main>
        <h1>Context API</h1>
        <p class="subtitle">
          Two concurrent providers — <strong>Session</strong> and <strong>Notifications</strong> — push reactive signals and functions to consumers scattered across the DOM tree. No prop drilling.
        </p>

        <session-provider>
          <notif-provider>

            <!-- Toolbar — consumes BOTH contexts -->
            <app-toolbar></app-toolbar>

            <ui-grid cols="2" gap="3">

              <!-- Team presence — session context -->
              <ui-card>
                <ui-header>
                  <ui-icon name="users" slot="leading" size="sm"></ui-icon>
                  <span slot="label">Team</span>
                </ui-header>
                <ui-body>
                  <team-presence></team-presence>
                </ui-body>
              </ui-card>

              <!-- Notification inbox — notification context -->
              <ui-card>
                <ui-header>
                  <ui-icon name="bell" slot="leading" size="sm"></ui-icon>
                  <span slot="label">Inbox</span>
                  <notif-panel-actions slot="trailing"></notif-panel-actions>
                </ui-header>
                <ui-body>
                  <notif-panel></notif-panel>
                </ui-body>
              </ui-card>

              <!-- Activity feed — notification context -->
              <ui-card>
                <ui-header>
                  <ui-icon name="pulse" slot="leading" size="sm"></ui-icon>
                  <span slot="label">Activity Feed</span>
                  <ui-badge slot="trailing" size="xs" intent="success">live</ui-badge>
                </ui-header>
                <ui-body>
                  <activity-feed></activity-feed>
                </ui-body>
              </ui-card>

              <!-- Preferences — session context (bidirectional) -->
              <ui-card>
                <ui-header>
                  <ui-icon name="gear" slot="leading" size="sm"></ui-icon>
                  <span slot="label">Preferences</span>
                </ui-header>
                <ui-body>
                  <notif-prefs></notif-prefs>
                </ui-body>
              </ui-card>

              <!-- Stats — notification context -->
              <ui-card style="grid-column: 1 / -1;">
                <ui-header>
                  <ui-icon name="chart-bar" slot="leading" size="sm"></ui-icon>
                  <span slot="label">Session Stats</span>
                </ui-header>
                <ui-body>
                  <session-stats></session-stats>
                </ui-body>
              </ui-card>

              <!-- Context event log -->
              <ui-card style="grid-column: 1 / -1;">
                <ui-header>
                  <ui-icon name="terminal" slot="leading" size="sm"></ui-icon>
                  <span slot="label">Context Event Log</span>
                  <ui-badge slot="trailing" size="xs">live</ui-badge>
                </ui-header>
                <ui-body>
                  <p style="font-size: 0.75rem; color: var(--neutral-ink-muted); margin-bottom: 0.5rem;">
                    Every context subscription and signal update is logged — proof that reactive state flows from providers to arbitrarily nested consumers.
                  </p>
                  <ctx-log></ctx-log>
                </ui-body>
              </ui-card>

            </ui-grid>

          </notif-provider>
        </session-provider>
      </main>
    </ui-layout>

    <script type="module">
      import '@nonoun/native-ui/register';


      import { UIElement } from '@nonoun/native-ui';
      import { define } from '@nonoun/native-ui';
      import { signal } from '@nonoun/native-ui';
      import { computed } from '@nonoun/native-ui';
      import { ContextProvider, ContextConsumer } from '@nonoun/native-ui';

      // ═══════════════════════════════════════════════════════════
      //  Data & Helpers
      // ═══════════════════════════════════════════════════════════

      const TEAM = [
        { name: 'You',              role: 'Engineer',         online: true,  intent: 'accent' },
        { name: 'Mika Tanaka',      role: 'Design Lead',      online: true,  intent: 'info' },
        { name: 'Priya Sharma',     role: 'Backend Engineer', online: true,  intent: 'success' },
        { name: 'Elias Krüger',     role: 'DevOps',           online: false, intent: 'warning' },
        { name: 'Sofia Reyes',      role: 'PM',               online: true,  intent: 'danger' },
        { name: 'Jonas Lindqvist',  role: 'Frontend',         online: false, intent: 'accent' },
      ];

      const ACTIVITY_SEEDS = [
        { actor: 'Mika Tanaka',     icon: 'rocket',       intent: 'accent',  text: 'pushed <strong>3 commits</strong> to <strong>main</strong>' },
        { actor: 'Priya Sharma',    icon: 'database',     intent: 'success', text: 'migrated the <strong>users</strong> table schema' },
        { actor: 'Sofia Reyes',     icon: 'check-circle', intent: 'success', text: 'closed issue <strong>#284</strong>' },
        { actor: 'Elias Krüger',    icon: 'cloud',        intent: 'info',    text: 'deployed <strong>staging</strong> environment' },
        { actor: 'Mika Tanaka',     icon: 'git-branch',   intent: 'accent',  text: 'created branch <strong>feat/context-api</strong>' },
        { actor: 'Priya Sharma',    icon: 'shield',       intent: 'warning', text: 'enabled <strong>rate limiting</strong> on /api/auth' },
        { actor: 'Sofia Reyes',     icon: 'lightning',     intent: 'danger',  text: 'flagged <strong>P0 bug</strong> in checkout flow' },
        { actor: 'Jonas Lindqvist', icon: 'package',      intent: 'info',    text: 'published <strong>@nonoun/native-ui@0.2.0</strong>' },
      ];

      const NOTIF_POOL = {
        info:    [
          { title: 'System update available', msg: 'v2.5.0 is ready — restart to apply.' },
          { title: 'Sync complete',           msg: 'All files synchronized with the cloud.' },
          { title: 'Maintenance scheduled',   msg: 'Brief downtime tonight at 2 AM UTC.' },
        ],
        success: [
          { title: 'Deploy successful',  msg: 'Production build v2.4.1 is now live.' },
          { title: 'All tests passing',  msg: '847 tests passed in 12.3s.' },
          { title: 'Backup complete',    msg: 'Daily backup finished — 2.3 GB archived.' },
        ],
        warning: [
          { title: 'Storage at 92%',       msg: 'Consider archiving old build artifacts.' },
          { title: 'Certificate expiring', msg: 'SSL cert expires in 7 days.' },
          { title: 'Rate limit at 85%',    msg: 'API usage approaching monthly quota.' },
        ],
        danger:  [
          { title: 'Build failed',    msg: 'Pipeline #847 failed — 3 tests broken.' },
          { title: 'Service outage',  msg: 'Database connection lost. Reconnecting...' },
          { title: 'Security alert',  msg: 'Login attempt from unrecognized device.' },
        ],
      };

      const INTENT_ICONS = { info: 'info', success: 'check-circle', warning: 'warning', danger: 'x-circle' };

      function pick(a) { return a[Math.floor(Math.random() * a.length)]; }
      function timestamp() {
        const d = new Date();
        return [d.getHours(), d.getMinutes(), d.getSeconds()].map(n => String(n).padStart(2, '0')).join(':') +
          '.' + String(d.getMilliseconds()).padStart(3, '0');
      }

      let nextId = 0;
      const logEntries = signal([]);
      function ctxLog(tag, msg) {
        logEntries.value = [{ id: ++nextId, tag, msg, ts: timestamp() }, ...logEntries.value].slice(0, 50);
      }

      // ═══════════════════════════════════════════════════════════
      //  PROVIDERS
      // ═══════════════════════════════════════════════════════════

      const ProviderBase = ContextProvider(UIElement);
      const ConsumerBase = ContextConsumer(UIElement);

      class SessionProvider extends ProviderBase {
        setup() {
          super.setup();
          this.provideContext('session', {
            userName: signal('You'),
            userRole: signal('Engineer'),
            status:   signal('online'),
            prefs: {
              desktop: signal(true),
              sound:   signal(false),
              email:   signal(true),
              dm:      signal(true),
            },
          });
          ctxLog('user', 'Session context provided');
        }
      }
      define('session-provider', SessionProvider);

      class NotifProvider extends ProviderBase {
        setup() {
          super.setup();
          const items = signal([]);
          const count = computed(() => items.value.length);
          const stats = signal({ info: 0, success: 0, warning: 0, danger: 0, total: 0, dismissed: 0 });

          const push = (title, msg, type = 'info') => {
            items.value = [{ id: ++nextId, title, msg, type }, ...items.value];
            stats.value = { ...stats.value, [type]: stats.value[type] + 1, total: stats.value.total + 1 };
            ctxLog('notif', `push "${title}" [${type}]`);
          };
          const dismiss = (id) => {
            const item = items.value.find(n => n.id === id);
            items.value = items.value.filter(n => n.id !== id);
            stats.value = { ...stats.value, dismissed: stats.value.dismissed + 1 };
            if (item) ctxLog('notif', `dismiss "${item.title}"`);
          };
          const clear = () => {
            const c = items.value.length;
            items.value = [];
            stats.value = { ...stats.value, dismissed: stats.value.dismissed + c };
            ctxLog('notif', `clear (${c} items)`);
          };

          this.provideContext('notifications', { items, count, stats, push, dismiss, clear });
          ctxLog('notif', 'Notification context provided');
          push('Deploy successful', 'Production build v2.4.1 is now live.', 'success');
          push('Rate limit at 85%', 'API usage approaching monthly quota.', 'warning');
        }
      }
      define('notif-provider', NotifProvider);

      // ═══════════════════════════════════════════════════════════
      //  APP TOOLBAR — consumes both contexts
      // ═══════════════════════════════════════════════════════════

      class AppToolbar extends ConsumerBase {
        setup() {
          super.setup();
          this.innerHTML = `
            <ui-toolbar>
              <div class="avatar-wrap">
                <ui-avatar name="You" size="sm" intent="accent"></ui-avatar>
                <ui-badge intent="success" floating dot></ui-badge>
              </div>
              <div class="toolbar-info">
                <div class="toolbar-name"></div>
                <div class="toolbar-role"></div>
              </div>
              <span style="flex:1;"></span>
              <ui-button variant="ghost" size="sm" intent="info" data-action="push">
                <ui-icon name="lightning" slot="leading"></ui-icon> Generate Event
              </ui-button>
            </ui-toolbar>
          `;

          this.requestContext('session', (ctx) => {
            ctxLog('user', 'Toolbar subscribed to session');
            this.addEffect(() => {
              const n = this.querySelector('.toolbar-name');
              const r = this.querySelector('.toolbar-role');
              if (n) n.textContent = ctx.userName.value;
              if (r) r.textContent = ctx.userRole.value + ' · ' + ctx.status.value;
            });
          });

          this.requestContext('notifications', (ctx) => {
            ctxLog('notif', 'Toolbar subscribed to notifications');
          });

          this.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-action="push"]');
            if (!btn) return;
            const ctx = this.getContext('notifications');
            if (!ctx) return;
            const type = pick(['info', 'success', 'warning', 'danger']);
            const tmpl = pick(NOTIF_POOL[type]);
            ctx.push(tmpl.title, tmpl.msg, type);
          });
        }
      }
      define('app-toolbar', AppToolbar);

      // ═══════════════════════════════════════════════════════════
      //  TEAM PRESENCE — session context
      // ═══════════════════════════════════════════════════════════

      class TeamPresence extends ConsumerBase {
        setup() {
          super.setup();
          this.requestContext('session', (ctx) => {
            ctxLog('user', 'Team presence subscribed');
            this.addEffect(() => {
              const myName = ctx.userName.value;
              this.innerHTML = TEAM.map(m => {
                const name = m.name === 'You' ? myName : m.name;
                const label = m.name === 'You' ? myName + ' (you)' : m.name;
                return `
                  <div class="row" style="display:flex;align-items:center;gap:0.5rem;">
                    <div class="avatar-wrap">
                      <ui-avatar name="${name}" size="sm" intent="${m.intent}"></ui-avatar>
                      <ui-badge intent="${m.online ? 'success' : 'neutral'}" floating dot></ui-badge>
                    </div>
                    <div>
                      <div class="presence-name">${label}</div>
                      <div class="presence-role">${m.role}${m.online ? '' : ' · offline'}</div>
                    </div>
                  </div>`;
              }).join('');
            });
          });
        }
      }
      define('team-presence', TeamPresence);

      // ═══════════════════════════════════════════════════════════
      //  NOTIFICATION PANEL — notification context (inline, no drawer)
      // ═══════════════════════════════════════════════════════════

      // Clear/count actions in card header trailing slot
      class NotifPanelActions extends ConsumerBase {
        setup() {
          super.setup();
          this.requestContext('notifications', (ctx) => {
            this.addEffect(() => {
              const c = ctx.count.value;
              this.innerHTML = `
                ${c > 0 ? `<ui-badge intent="danger" size="xs">${c}</ui-badge>` : ''}
                <ui-button variant="ghost" size="xs" data-action="clear" ${c === 0 ? 'disabled' : ''}>
                  <ui-icon name="trash" slot="leading"></ui-icon>
                </ui-button>
              `;
            });
          });

          this.addEventListener('click', (e) => {
            if (e.target.closest('[data-action="clear"]')) {
              const ctx = this.getContext('notifications');
              if (ctx) ctx.clear();
            }
          });
        }
      }
      define('notif-panel-actions', NotifPanelActions);

      class NotifPanel extends ConsumerBase {
        setup() {
          super.setup();
          this.requestContext('notifications', (ctx) => {
            ctxLog('notif', 'Inbox panel subscribed');
            this.addEffect(() => {
              const list = ctx.items.value;
              if (list.length === 0) {
                this.innerHTML = `
                  <ui-stack align="center" gap="2" style="padding: 2rem 0; color: var(--neutral-ink-muted); font-size: 0.8125rem;">
                    <ui-icon name="bell" size="28"></ui-icon>
                    <span>All clear — no notifications</span>
                  </ui-stack>`;
                return;
              }
              this.innerHTML = list.map(n => `
                <div class="notif-row" style="display:flex;align-items:flex-start;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid var(--neutral-border-muted);">
                  <div class="activity-dot ${n.type}">
                    <ui-icon name="${INTENT_ICONS[n.type]}" size="14"></ui-icon>
                  </div>
                  <div class="notif-text" style="flex:1;min-width:0;">
                    <strong>${n.title}</strong>
                    <p>${n.msg}</p>
                  </div>
                  <ui-button variant="ghost" size="xs" data-dismiss="${n.id}">
                    <ui-icon name="x" slot="leading"></ui-icon>
                  </ui-button>
                </div>
              `).join('');
            });
          });

          this.addEventListener('click', (e) => {
            const btn = e.target.closest('[data-dismiss]');
            if (!btn) return;
            const ctx = this.getContext('notifications');
            if (ctx) ctx.dismiss(Number(btn.dataset.dismiss));
          });
        }
      }
      define('notif-panel', NotifPanel);

      // ═══════════════════════════════════════════════════════════
      //  ACTIVITY FEED — notification context
      // ═══════════════════════════════════════════════════════════

      class ActivityFeed extends ConsumerBase {
        setup() {
          super.setup();
          const activities = signal(
            ACTIVITY_SEEDS.slice(0, 4).map(a => ({ ...a, id: ++nextId, time: pick(['2m ago', '5m ago', '12m ago', '30m ago']) }))
          );

          this.requestContext('notifications', (ctx) => {
            ctxLog('notif', 'Activity feed subscribed');
            let prevCount = ctx.items.value.length;
            this.addEffect(() => {
              const items = ctx.items.value;
              if (items.length > prevCount && items.length > 0) {
                const newest = items[0];
                const tmpl = pick(ACTIVITY_SEEDS);
                activities.value = [
                  { ...tmpl, id: ++nextId, text: `triggered <strong>${newest.title}</strong>`, time: 'just now' },
                  ...activities.value,
                ].slice(0, 8);
              }
              prevCount = items.length;
            });
          });

          this.addEffect(() => {
            const list = activities.value;
            if (list.length === 0) {
              this.innerHTML = '<div style="text-align:center;padding:2rem;color:var(--neutral-ink-muted);font-size:0.8125rem;">No activity yet</div>';
              return;
            }
            this.innerHTML = list.map(a => `
              <div class="activity-row" style="display:flex;align-items:flex-start;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid var(--neutral-border-muted);">
                <div class="activity-dot ${a.intent}">
                  <ui-icon name="${a.icon}" size="14"></ui-icon>
                </div>
                <div style="flex:1;min-width:0;">
                  <div class="activity-text"><strong>${a.actor}</strong> ${a.text}</div>
                  <div class="activity-time">${a.time}</div>
                </div>
              </div>
            `).join('');
          });
        }
      }
      define('activity-feed', ActivityFeed);

      // ═══════════════════════════════════════════════════════════
      //  PREFERENCES — session context (bidirectional)
      // ═══════════════════════════════════════════════════════════

      class NotifPrefs extends ConsumerBase {
        setup() {
          super.setup();
          const PREFS = [
            { key: 'desktop', label: 'Desktop notifications', desc: 'Show system-level alerts' },
            { key: 'sound',   label: 'Sound',                 desc: 'Play a chime on new events' },
            { key: 'email',   label: 'Email digest',          desc: 'Daily summary at 9 AM' },
            { key: 'dm',      label: 'Direct messages',       desc: 'Notify on team messages' },
          ];

          this.requestContext('session', (ctx) => {
            ctxLog('pref', 'Preferences subscribed to session');
            this.innerHTML = PREFS.map(p => `
              <div style="display:flex;align-items:center;justify-content:space-between;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--neutral-border-muted);">
                <div>
                  <div class="pref-label">${p.label}</div>
                  <div class="pref-desc">${p.desc}</div>
                </div>
                <ui-switch size="sm" data-pref="${p.key}" ${ctx.prefs[p.key].value ? 'checked' : ''}></ui-switch>
              </div>
            `).join('');
          });

          this.addEventListener('ui-change', (e) => {
            const sw = e.target.closest('ui-switch');
            if (!sw) return;
            const key = sw.dataset.pref;
            const ctx = this.getContext('session');
            if (key && ctx?.prefs[key]) {
              ctx.prefs[key].value = sw.checked;
              ctxLog('pref', `${key} → ${sw.checked ? 'on' : 'off'}`);
            }
          });
        }
      }
      define('notif-prefs', NotifPrefs);

      // ═══════════════════════════════════════════════════════════
      //  SESSION STATS — notification context
      // ═══════════════════════════════════════════════════════════

      class SessionStats extends ConsumerBase {
        setup() {
          super.setup();
          this.requestContext('notifications', (ctx) => {
            ctxLog('notif', 'Stats subscribed');
            this.addEffect(() => {
              const s = ctx.stats.value;
              this.innerHTML = `
                <ui-stack gap="3">
                  <ui-grid cols="4" gap="2">
                    <ui-stack gap="1">
                      <div class="stat-value" style="color: var(--info-ink);">${s.info}</div>
                      <div class="stat-label">Info</div>
                    </ui-stack>
                    <ui-stack gap="1">
                      <div class="stat-value" style="color: var(--success-ink);">${s.success}</div>
                      <div class="stat-label">Success</div>
                    </ui-stack>
                    <ui-stack gap="1">
                      <div class="stat-value" style="color: var(--warning-ink);">${s.warning}</div>
                      <div class="stat-label">Warning</div>
                    </ui-stack>
                    <ui-stack gap="1">
                      <div class="stat-value" style="color: var(--danger-ink);">${s.danger}</div>
                      <div class="stat-label">Danger</div>
                    </ui-stack>
                  </ui-grid>
                  <div style="display:flex;justify-content:center;gap:1.5rem;font-size:0.75rem;color:var(--neutral-ink-muted);">
                    <span><strong style="color:var(--neutral-ink);">${s.total}</strong> total</span>
                    <span><strong style="color:var(--neutral-ink);">${s.dismissed}</strong> dismissed</span>
                    <span><strong style="color:var(--neutral-ink);">${ctx.count.value}</strong> pending</span>
                  </div>
                </ui-stack>`;
            });
          });
        }
      }
      define('session-stats', SessionStats);

      // ═══════════════════════════════════════════════════════════
      //  CONTEXT EVENT LOG
      // ═══════════════════════════════════════════════════════════

      class CtxLog extends UIElement {
        setup() {
          super.setup();
          this.addEffect(() => {
            const entries = logEntries.value;
            if (entries.length === 0) {
              this.innerHTML = '<div class="ctx-log" style="font-style:italic;color:var(--neutral-ink-muted);">Waiting for events...</div>';
              return;
            }
            this.innerHTML = '<div class="ctx-log">' + entries.map(e =>
              `<div class="log-entry"><span class="log-tag ${e.tag}">[${e.tag}]</span>${e.msg}<span class="log-ts">${e.ts}</span></div>`
            ).join('') + '</div>';
          });
        }
      }
      define('ctx-log', CtxLog);
    </script>
  </body>
</html>
