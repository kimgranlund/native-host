---
import SidebarLayout from '../../layouts/SidebarLayout.astro';

const codeExamples = {
  scrollIntoViewProvider: `&lt;ui-controller traits="intersectable"&gt;
  &lt;div class="intersect-box"&gt;
    Box 1
  &lt;/div&gt;
&lt;/ui-controller&gt;

&lt;!-- CSS --&gt;
.intersect-box {
  opacity: 0;
  transform: translateY(1.5rem);
  transition: opacity 600ms ease, transform 600ms ease;
}
.intersect-box[intersecting] {
  opacity: 1;
  transform: translateY(0);
}`,
};
const detailIntersection = `{ isIntersecting, ratio }`;
---
<SidebarLayout title="Intersectable">
  <main>
<h1>Intersectable</h1>
    <p style="color: var(--neutral-ink-muted); font-size: 0.875rem; margin-bottom: 1.5rem;">
      IntersectionObserver wrapper for visibility-triggered behavior. Sets <code>[intersecting]</code> when the element enters the viewport and dispatches <code>ui-intersect</code>.
    </p>

    <!-- ── Scroll Into View (Provider) ── -->

    <h2>Scroll Into View (Provider)</h2>
    <div class="layout-section">
      <p style="font-size: 0.75rem; color: var(--neutral-ink-muted); margin-bottom: 0.75rem;">
        <code>&lt;ui-controller traits="intersectable"&gt;</code> wraps each box. Scroll down to see them appear with a CSS fade-in animation.
      </p>
      <div class="scroll-spacer">&#8595; Scroll down to reveal boxes &#8595;</div>
      <ui-controller traits="intersectable">
        <div class="intersect-box">
          <span class="intersect-label">Box 1</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <ui-controller traits="intersectable">
        <div class="intersect-box">
          <span class="intersect-label">Box 2</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <ui-controller traits="intersectable">
        <div class="intersect-box">
          <span class="intersect-label">Box 3</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <ui-controller traits="intersectable">
        <div class="intersect-box">
          <span class="intersect-label">Box 4</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <div id="scroll-log" class="output"></div>
      <pre class="layout-code"><code set:html={codeExamples.scrollIntoViewProvider} /><ui-button class="copy-btn" size="sm" variant="ghost" aria-label="Copy"><ui-icon name="copy"></ui-icon></ui-button></pre>
    </div>

    <!-- ── Once Mode (Provider) ── -->

    <h2>Once Mode (Provider)</h2>
    <div class="layout-section">
      <p style="font-size: 0.75rem; color: var(--neutral-ink-muted); margin-bottom: 0.75rem;">
        <code>intersectable-once="true"</code>. The element fades in and stays visible permanently. The observer disconnects after the first intersection.
      </p>
      <div class="scroll-spacer">&#8595; Scroll down — these only animate once &#8595;</div>
      <ui-controller traits="intersectable" intersectable-once="true">
        <div class="intersect-box" id="once-a">
          <span class="intersect-label">Once A</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <ui-controller traits="intersectable" intersectable-once="true">
        <div class="intersect-box" id="once-b">
          <span class="intersect-label">Once B</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <ui-controller traits="intersectable" intersectable-once="true">
        <div class="intersect-box" id="once-c">
          <span class="intersect-label">Once C</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <div id="once-log" class="output"></div>
      <pre class="layout-code"><code>&lt;ui-controller traits="intersectable" intersectable-once="true"&gt;
  &lt;div class="intersect-box"&gt;
    Once A
  &lt;/div&gt;
&lt;/ui-controller&gt;</code><ui-button class="copy-btn" size="sm" variant="ghost" aria-label="Copy"><ui-icon name="copy"></ui-icon></ui-button></pre>
    </div>

    <!-- ── Threshold (Provider) ── -->

    <h2>Threshold (50%)</h2>
    <div class="layout-section">
      <p style="font-size: 0.75rem; color: var(--neutral-ink-muted); margin-bottom: 0.75rem;">
        <code>intersectable-threshold="0.5"</code>. Only triggers when at least 50% of the element is visible.
      </p>
      <div class="scroll-spacer">&#8595; Scroll down — requires 50% visibility &#8595;</div>
      <ui-controller traits="intersectable" intersectable-threshold="0.5">
        <div class="intersect-box">
          <span class="intersect-label">50% Threshold A</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <ui-controller traits="intersectable" intersectable-threshold="0.5">
        <div class="intersect-box">
          <span class="intersect-label">50% Threshold B</span>
          <span class="intersect-status">hidden</span>
        </div>
      </ui-controller>
      <div id="threshold-log" class="output"></div>
      <pre class="layout-code"><code>&lt;ui-controller traits="intersectable" intersectable-threshold="0.5"&gt;
  &lt;div class="intersect-box"&gt;
    50% Threshold
  &lt;/div&gt;
&lt;/ui-controller&gt;</code><ui-button class="copy-btn" size="sm" variant="ghost" aria-label="Copy"><ui-icon name="copy"></ui-icon></ui-button></pre>
    </div>

    <!-- ── API Reference ── -->

    <h2>API</h2>

    <div class="api-section">
      <h3>Provider Usage</h3>
      <table class="api-table">
        <thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Description</th></tr></thead>
        <tbody>
          <tr>
            <td><code>intersectable-threshold</code></td>
            <td><code>number</code></td>
            <td><code>0</code></td>
            <td>Visibility ratio (0 to 1) required to trigger. <code>0</code> = any pixel visible.</td>
          </tr>
          <tr>
            <td><code>intersectable-once</code></td>
            <td><code>boolean</code></td>
            <td><code>false</code></td>
            <td>When <code>"true"</code>, the observer disconnects after the first intersection.</td>
          </tr>
          <tr>
            <td><code>intersectable-disabled</code></td>
            <td><code>boolean</code></td>
            <td><code>false</code></td>
            <td>Disables the observer when <code>"true"</code>.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="api-section">
      <h3>Events</h3>
      <table class="api-table">
        <thead><tr><th>Event</th><th>Detail</th><th>Description</th></tr></thead>
        <tbody>
          <tr>
            <td><code>ui-intersect</code></td>
            <td><code set:html={detailIntersection} /></td>
            <td>Fired when visibility changes.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="api-section">
      <h3>CSS</h3>
      <table class="api-table">
        <thead><tr><th>Selector</th><th>Description</th></tr></thead>
        <tbody>
          <tr>
            <td><code>[intersecting]</code></td>
            <td>Present on the element while it meets the intersection threshold.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
import '../../scripts/copy-buttons';

      // ── Helpers ──

      function appendLog(el, msg) {
        const line = document.createElement('div');
        line.textContent = msg;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
      }

      function bindStatus(el) {
        const badge = el.querySelector('.intersect-status');
        el.addEventListener('ui-intersect', (e) => {
          badge.textContent = e.detail.isIntersecting ? 'visible' : 'hidden';
        });
      }

      // ── Bind status badges ──

      for (const el of document.querySelectorAll('.intersect-box')) {
        bindStatus(el);
      }

      // ── Once mode: add .revealed class on first intersection ──

      for (const el of [document.getElementById('once-a'), document.getElementById('once-b'), document.getElementById('once-c')]) {
        el.addEventListener('ui-intersect', (e) => {
          if (e.detail.isIntersecting) el.classList.add('revealed');
        });
      }

      // ── Event logging: Scroll Into View ──

      const scrollLogEl = document.getElementById('scroll-log');
      const scrollBoxes = document.querySelectorAll('.layout-section:nth-of-type(1) .intersect-box');
      for (const el of scrollBoxes) {
        el.addEventListener('ui-intersect', (e) => {
          const label = el.querySelector('.intersect-label').textContent;
          appendLog(scrollLogEl, `${label}: ${e.detail.isIntersecting ? 'enter' : 'leave'} (ratio: ${e.detail.ratio.toFixed(2)})`);
        });
      }

      // ── Event logging: Once mode ──

      const onceLogEl = document.getElementById('once-log');
      for (const el of [document.getElementById('once-a'), document.getElementById('once-b'), document.getElementById('once-c')]) {
        el.addEventListener('ui-intersect', (e) => {
          const label = el.querySelector('.intersect-label').textContent;
          appendLog(onceLogEl, `${label}: ${e.detail.isIntersecting ? 'enter (observer disconnects)' : 'leave'}`);
        });
      }

      // ── Event logging: Threshold ──

      const thresholdLogEl = document.getElementById('threshold-log');
      const thresholdBoxes = document.querySelectorAll('.layout-section:last-of-type .intersect-box');
      for (const el of thresholdBoxes) {
        el.addEventListener('ui-intersect', (e) => {
          const label = el.querySelector('.intersect-label').textContent;
          appendLog(thresholdLogEl, `${label}: ${e.detail.isIntersecting ? 'enter' : 'leave'} (ratio: ${e.detail.ratio.toFixed(2)})`);
        });
      }
  </script>
  <style is:global>
    /* ── Intersect Boxes ── */

    .scroll-spacer {
      font-size: 0.75rem;
      color: var(--neutral-ink-muted);
      text-align: center;
      padding: 1rem 0;
    }

    .intersect-box {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 6rem;
      padding: 1rem;
      margin-bottom: 1rem;
      background: var(--neutral-panel);
      border: 1px solid var(--neutral-border-muted);
      border-radius: var(--_radius);
      font-size: 0.875rem;
      color: var(--neutral-ink-muted);
      opacity: 0;
      transform: translateY(1.5rem);
      transition: opacity 600ms ease, transform 600ms ease, background 300ms ease, border-color 300ms ease, color 300ms ease;
    }

    .intersect-box[intersecting] {
      opacity: 1;
      transform: translateY(0);
      background: var(--accent-surface);
      border-color: var(--accent-border);
      color: var(--accent-surface-ink);
    }

    /* Once mode: keep visible after first intersection */
    .intersect-box.revealed {
      opacity: 1;
      transform: translateY(0);
    }

    .intersect-label {
      font-weight: 600;
    }

    .intersect-status {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.125rem 0.5rem;
      border-radius: 9999px;
      background: var(--neutral-border-muted);
      color: var(--neutral-ink-muted);
      margin-left: 0.75rem;
      transition: background 200ms ease, color 200ms ease;
    }

    [intersecting] .intersect-status {
      background: var(--accent-ink);
      color: var(--accent-surface);
    }

    .output {
      font-family: monospace;
      font-size: 0.75rem;
      color: var(--neutral-ink-muted);
      max-height: 6rem;
      overflow-y: auto;
      margin-top: 0.75rem;
      padding: 0.5rem;
      background: var(--neutral-panel);
      border-radius: 0.25rem;
    }

    /* ── Code Blocks ── */




    /* ── API Reference ── */

    .api-section {
      margin-bottom: 1.5rem;
    }

    .api-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }

    .api-table th {
      text-align: left;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-bottom: 2px solid var(--neutral-border-muted);
      color: var(--neutral-ink-strong);
    }

    .api-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--neutral-border-muted);
      vertical-align: top;
    }

    .api-table code {
      font-family: ui-monospace, monospace;
      font-size: 0.75rem;
      background: var(--neutral-panel);
      padding: 0.0625rem 0.3125rem;
      border-radius: 0.1875rem;
    }

    .api-table td:first-child code {
      white-space: nowrap;
    }
</style>

</SidebarLayout>
