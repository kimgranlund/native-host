---
import SidebarLayout from '../../layouts/SidebarLayout.astro';

const codeExamples = {
  basicFilter: `import { SearchController } from '@nonoun/native-ui';

const wrap = document.getElementById('basic-wrap');
const search = new SearchController(wrap, {
  selector: '.search-item',
});

const input = document.getElementById('basic-input');
input.addEventListener('ui-input', (e) =&gt; {
  search.filter(e.detail.value);
});

wrap.addEventListener('ui-search', (e) =&gt; {
  const { query, matchCount, total } = e.detail;
  console.log(\`"\${query}" — \${matchCount}/\${total} matches\`);
});`,
  customTextField: `import { SearchController } from '@nonoun/native-ui';

const wrap = document.getElementById('field-wrap');
const search = new SearchController(wrap, {
  selector: '.search-item',
  textField: 'data-search',
});

const input = document.getElementById('field-input');
input.addEventListener('ui-input', (e) =&gt; {
  search.filter(e.detail.value);
});`,
  highlightMatches: `import { SearchController } from '@nonoun/native-ui';

const wrap = document.getElementById('highlight-wrap');
const search = new SearchController(wrap, {
  selector: '.search-item',
});

const input = document.getElementById('highlight-input');
input.addEventListener('ui-input', (e) =&gt; {
  const query = e.detail.value;
  search.filter(query);
  // Apply highlight to visible items
  for (const item of wrap.querySelectorAll('.search-item')) {
    const original = item.getAttribute('data-original');
    item.innerHTML = SearchController.highlight(original, query);
  }
});`,
  searchcontrollerAttachToAnyElement: `import { SearchController } from '@nonoun/native-ui';

const list = document.querySelector('#controller-list');
const search = new SearchController(list, {
  selector: '.search-item',
});

input.addEventListener('ui-input', (e) =&gt; {
  const { matches, hidden, total } = search.filter(e.detail.value);
  log(\`\${matches.length}/\${total} matches\`);
});

// Later: search.clear();
// Later: search.destroy();`,
};
const detailMatchesHiddenTotal = `{ matches, hidden, total }`;
const detailQueryMatchTotal = `{ query, matchCount, total }`;
---
<SidebarLayout title="Searchable">
  <main>
<h1>Searchable</h1>
    <p style="color: var(--neutral-ink-muted); font-size: 0.875rem; margin-bottom: 1.5rem;">
      Text filtering with match/hide attributes and highlight support. Non-matching items receive <code>[search-hidden]</code>, matching items get <code>[search-match]</code>. Since searching requires calling <code>filter()</code> imperatively from input events, all demos use direct <code>SearchController</code> instantiation. The <code>&lt;ui-controller traits="searchable"&gt;</code> provider can create the controller declaratively, but <code>filter()</code> must still be called.
    </p>

    <!-- ── Basic Filter ── -->

    <h2>Basic Filter</h2>
    <div class="layout-section">
      <p style="font-size: 0.75rem; color: var(--neutral-ink-muted); margin-bottom: 0.75rem;">
        Type to filter items. Non-matching items are hidden via <code>[search-hidden]</code>.
      </p>
      <div id="basic-wrap">
        <ui-input id="basic-input" placeholder="Filter items..." style="margin-bottom: 0.75rem"></ui-input>
        <div class="search-items">
          <div class="search-item">Apple</div>
          <div class="search-item">Banana</div>
          <div class="search-item">Cherry</div>
          <div class="search-item">Date</div>
          <div class="search-item">Elderberry</div>
          <div class="search-item">Fig</div>
          <div class="search-item">Grape</div>
        </div>
      </div>
      <div id="basic-log" class="output"></div>
      <pre class="layout-code"><code set:html={codeExamples.basicFilter} /><ui-button class="copy-btn" size="sm" variant="ghost" aria-label="Copy"><ui-icon name="copy"></ui-icon></ui-button></pre>
    </div>

    <!-- ── Custom Text Field ── -->

    <h2>Custom Text Field</h2>
    <div class="layout-section">
      <p style="font-size: 0.75rem; color: var(--neutral-ink-muted); margin-bottom: 0.75rem;">
        Searches against a <code>data-search</code> attribute instead of <code>textContent</code>. Items display a label but filter on tags.
      </p>
      <div id="field-wrap">
        <ui-input id="field-input" placeholder="Search by tag (e.g. 'ui', 'layout')..." style="margin-bottom: 0.75rem"></ui-input>
        <div class="search-items">
          <div class="search-item" data-search="component ui button">Button Component</div>
          <div class="search-item" data-search="component ui input form">Input Field</div>
          <div class="search-item" data-search="layout grid responsive">Grid Layout</div>
          <div class="search-item" data-search="layout stack flex">Stack Container</div>
          <div class="search-item" data-search="color token theme">Color Tokens</div>
          <div class="search-item" data-search="typography font text">Typography Scale</div>
        </div>
      </div>
      <pre class="layout-code"><code set:html={codeExamples.customTextField} /><ui-button class="copy-btn" size="sm" variant="ghost" aria-label="Copy"><ui-icon name="copy"></ui-icon></ui-button></pre>
    </div>

    <!-- ── Highlight ── -->

    <h2>Highlight Matches</h2>
    <div class="layout-section">
      <p style="font-size: 0.75rem; color: var(--neutral-ink-muted); margin-bottom: 0.75rem;">
        Uses <code>SearchController.highlight()</code> to wrap matches in <code>&lt;mark&gt;</code> tags.
      </p>
      <div id="highlight-wrap">
        <ui-input id="highlight-input" placeholder="Type to highlight matches..." style="margin-bottom: 0.75rem"></ui-input>
        <div class="search-items">
          <div class="search-item" data-original="JavaScript">JavaScript</div>
          <div class="search-item" data-original="TypeScript">TypeScript</div>
          <div class="search-item" data-original="CoffeeScript">CoffeeScript</div>
          <div class="search-item" data-original="ActionScript">ActionScript</div>
          <div class="search-item" data-original="PureScript">PureScript</div>
        </div>
      </div>
      <pre class="layout-code"><code set:html={codeExamples.highlightMatches} /><ui-button class="copy-btn" size="sm" variant="ghost" aria-label="Copy"><ui-icon name="copy"></ui-icon></ui-button></pre>
    </div>

    <!-- ── SearchController Direct ── -->

    <h2>SearchController — Attach to Any Element</h2>
    <div class="layout-section">
      <p style="font-size: 0.75rem; color: var(--neutral-ink-muted); margin-bottom: 0.75rem;">
        Use <code>SearchController</code> directly on a plain element without the trait mixin.
      </p>
      <div id="controller-wrap">
        <ui-input id="ctrl-input" placeholder="Filter colors..." style="margin-bottom: 0.75rem"></ui-input>
        <div id="controller-list" class="search-items">
          <div class="search-item">Red</div>
          <div class="search-item">Orange</div>
          <div class="search-item">Yellow</div>
          <div class="search-item">Green</div>
          <div class="search-item">Blue</div>
          <div class="search-item">Indigo</div>
          <div class="search-item">Violet</div>
        </div>
      </div>
      <div id="ctrl-log" class="output"></div>
      <pre class="layout-code"><code set:html={codeExamples.searchcontrollerAttachToAnyElement} /><ui-button class="copy-btn" size="sm" variant="ghost" aria-label="Copy"><ui-icon name="copy"></ui-icon></ui-button></pre>
    </div>

    <!-- ── API Reference ── -->

    <h2>API</h2>

    <div class="api-section">
      <h3>Constructor Options</h3>
      <table class="api-table">
        <thead><tr><th>Option</th><th>Type</th><th>Default</th><th>Description</th></tr></thead>
        <tbody>
          <tr>
            <td><code>selector</code></td>
            <td><code>string</code></td>
            <td>—</td>
            <td>CSS selector for searchable items within the host. Required.</td>
          </tr>
          <tr>
            <td><code>textField</code></td>
            <td><code>string</code></td>
            <td><code>'textContent'</code></td>
            <td>Property or attribute name to match against. Use <code>'textContent'</code> or a data attribute name.</td>
          </tr>
          <tr>
            <td><code>disabled</code></td>
            <td><code>boolean</code></td>
            <td><code>false</code></td>
            <td>Disables filtering when true. All items remain visible.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="api-section">
      <h3>Controller Methods</h3>
      <table class="api-table">
        <thead><tr><th>Method</th><th>Returns</th><th>Description</th></tr></thead>
        <tbody>
          <tr>
            <td><code>filter(query)</code></td>
            <td><code set:html={detailMatchesHiddenTotal} /></td>
            <td>Filter items by query. Sets <code>[search-hidden]</code> and <code>[search-match]</code> attributes.</td>
          </tr>
          <tr>
            <td><code>clear()</code></td>
            <td>—</td>
            <td>Remove all search attributes and reset the query.</td>
          </tr>
          <tr>
            <td><code>static highlight(text, query)</code></td>
            <td><code>string</code></td>
            <td>Wrap matching substrings in <code>&lt;mark&gt;</code> tags. Returns HTML string.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="api-section">
      <h3>Events</h3>
      <table class="api-table">
        <thead><tr><th>Event</th><th>Detail</th><th>Description</th></tr></thead>
        <tbody>
          <tr>
            <td><code>ui-search</code></td>
            <td><code set:html={detailQueryMatchTotal} /></td>
            <td>Fired after filtering. <code>matchCount</code> is the number of visible items.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="api-section">
      <h3>CSS Attributes</h3>
      <table class="api-table">
        <thead><tr><th>Attribute</th><th>Set on</th><th>Description</th></tr></thead>
        <tbody>
          <tr>
            <td><code>[search-hidden]</code></td>
            <td>Non-matching items</td>
            <td>Present on items that do not match the query. Style with <code>display: none</code>.</td>
          </tr>
          <tr>
            <td><code>[search-match]</code></td>
            <td>Matching items</td>
            <td>Present on items that match the current query.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="api-section">
      <h3>Provider Usage (<code>&lt;ui-controller traits="searchable"&gt;</code>)</h3>
      <table class="api-table">
        <thead><tr><th>Attribute</th><th>Type</th><th>Default</th><th>Description</th></tr></thead>
        <tbody>
          <tr>
            <td><code>searchable-selector</code></td>
            <td><code>string</code></td>
            <td>—</td>
            <td>CSS selector for searchable items. Required.</td>
          </tr>
          <tr>
            <td><code>searchable-text-field</code></td>
            <td><code>string</code></td>
            <td><code>'textContent'</code></td>
            <td>Property or attribute to match against.</td>
          </tr>
          <tr>
            <td><code>searchable-disabled</code></td>
            <td><code>boolean</code></td>
            <td><code>false</code></td>
            <td>Disables filtering.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>

  <script>
import '../../scripts/copy-buttons';

      // ── Helper: event logging ──

      function appendLog(el, msg) {
        if (!el) return;
        const line = document.createElement('div');
        line.textContent = msg;
        el.appendChild(line);
        el.scrollTop = el.scrollHeight;
        while (el.children.length > 20) el.removeChild(el.firstChild);
      }

      // ── Basic Filter ──

      const basicWrap = document.getElementById('basic-wrap');
      const basicSearch = new SearchController(basicWrap, {
        selector: '.search-item',
      });

      const basicInput = document.getElementById('basic-input');
      basicInput.addEventListener('ui-input', (e) => {
        basicSearch.filter(e.detail.value);
      });

      const basicLogEl = document.getElementById('basic-log');
      basicWrap.addEventListener('ui-search', (e) => {
        const { query, matchCount, total } = e.detail;
        appendLog(basicLogEl, `"${query}" — ${matchCount}/${total} matches`);
      });

      // ── Custom Text Field ──

      const fieldWrap = document.getElementById('field-wrap');
      const fieldSearch = new SearchController(fieldWrap, {
        selector: '.search-item',
        textField: 'data-search',
      });

      const fieldInput = document.getElementById('field-input');
      fieldInput.addEventListener('ui-input', (e) => {
        fieldSearch.filter(e.detail.value);
      });

      // ── Highlight Matches ──

      const highlightWrap = document.getElementById('highlight-wrap');
      const highlightSearch = new SearchController(highlightWrap, {
        selector: '.search-item',
      });

      const highlightInput = document.getElementById('highlight-input');
      highlightInput.addEventListener('ui-input', (e) => {
        const query = e.detail.value;
        highlightSearch.filter(query);
        for (const item of highlightWrap.querySelectorAll('.search-item')) {
          const original = item.getAttribute('data-original');
          item.innerHTML = SearchController.highlight(original, query);
        }
      });

      // ── SearchController — Attach to Any Element ──

      const ctrlList = document.getElementById('controller-list');
      const ctrlSearch = new SearchController(ctrlList, {
        selector: '.search-item',
      });

      const ctrlInput = document.getElementById('ctrl-input');
      ctrlInput.addEventListener('ui-input', (e) => {
        const { matches, hidden, total } = ctrlSearch.filter(e.detail.value);
        appendLog(ctrlLogEl, `${matches.length}/${total} matches`);
      });

      const ctrlLogEl = document.getElementById('ctrl-log');
      ctrlList.addEventListener('ui-search', (e) => {
        const { query, matchCount, total } = e.detail;
        appendLog(ctrlLogEl, `"${query}" — ${matchCount}/${total} matches`);
      });
  </script>
  <style is:global>
    /* ── Search Items ── */

    .search-items {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .search-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.625rem 0.75rem;
      background: var(--neutral-panel);
      border: 1px solid var(--neutral-border-muted);
      border-radius: 0.375rem;
      font-size: 0.875rem;
      transition: opacity 150ms ease;
    }

    .search-item[search-hidden] {
      display: none;
    }

    .search-item[search-match] {
      border-color: var(--neutral-border-muted);
    }

    .search-item mark {
      background: var(--accent-surface);
      color: var(--accent-surface-ink);
      padding: 0 0.125rem;
      border-radius: 0.125rem;
    }

    .output {
      font-family: monospace;
      font-size: 0.75rem;
      color: var(--neutral-ink-muted);
      max-height: 6rem;
      overflow-y: auto;
      margin-top: 0.75rem;
      padding: 0.5rem;
      background: var(--neutral-panel);
      border-radius: 0.25rem;
    }

    /* ── Code Blocks ── */




    /* ── API Reference ── */

    .api-section {
      margin-bottom: 1.5rem;
    }

    .api-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
    }

    .api-table th {
      text-align: left;
      font-weight: 600;
      padding: 0.5rem 0.75rem;
      border-bottom: 2px solid var(--neutral-border-muted);
      color: var(--neutral-ink-strong);
    }

    .api-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid var(--neutral-border-muted);
      vertical-align: top;
    }

    .api-table code {
      font-family: ui-monospace, monospace;
      font-size: 0.75rem;
      background: var(--neutral-panel);
      padding: 0.0625rem 0.3125rem;
      border-radius: 0.1875rem;
    }

    .api-table td:first-child code {
      white-space: nowrap;
    }
</style>

</SidebarLayout>
