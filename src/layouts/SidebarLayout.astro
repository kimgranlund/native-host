---
import BaseLayout from './BaseLayout.astro';
import sitemap from '../data/sitemap.json';

interface Props {
  title: string;
}
const { title } = Astro.props;

const currentPath = Astro.url.pathname.replace(/\/$/, '') || '/';
const currentEntry = sitemap.find(e => e.path === currentPath);

// Group sitemap entries
const groups = new Map<string, typeof sitemap>();
for (const entry of sitemap) {
  if (!groups.has(entry.group)) groups.set(entry.group, []);
  groups.get(entry.group)!.push(entry);
}

const groupIcons: Record<string, string> = {
  Components: 'cube',
  Containers: 'package',
  Traits: 'lightning',
  Blocks: 'squares-four',
  Core: 'cpu',
  Other: 'compass',
};
---
<BaseLayout title={title}>
  <style is:global>
    @import '../styles/layout.css';
    @import '../styles/layout-blocks.css';
    @import '@nonoun/native-ui/css/inspector';
  </style>

  <ui-layout-sidebar id="layout-sidebar">
    <script is:inline>
      try { if (localStorage.getItem('nav-sidebar-collapsed') === 'true')
        document.getElementById('layout-sidebar').setAttribute('collapsed', '');
      } catch(e) {}
    </script>
    <aside slot="sidebar">
      <ui-layout-sidebar-header>
        <ui-layout-sidebar-trigger>
          <span class="nav-logo">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="3" y="3" width="18" height="18" rx="4" stroke="currentColor" stroke-width="2"/>
              <path d="M8 16V8l8 8V8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
          <span slot="label">NativeUI</span>
          <ui-icon name="caret-up-down" slot="trailing"></ui-icon>
          <ui-listbox popover="manual">
            <ui-option-group>
              <ui-option-group-header>Teams</ui-option-group-header>
              <ui-option value="native-ui" selected>
                <span class="nav-logo">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="3" width="18" height="18" rx="4" stroke="currentColor" stroke-width="2"/>
                    <path d="M8 16V8l8 8V8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                NativeUI
              </ui-option>
            </ui-option-group>
            <ui-option-group>
              <ui-option value="add-team"><ui-icon name="plus"></ui-icon> Add team</ui-option>
            </ui-option-group>
          </ui-listbox>
        </ui-layout-sidebar-trigger>
      </ui-layout-sidebar-header>

      <ui-layout-sidebar-content>
        <ui-button
          class="nav-search-hint"
          size="md"
          radius="default"
          justify="spread"
          id="nav-search-btn"
        >
          <ui-icon name="magnifying-glass" slot="leading"></ui-icon>
          <span slot="label">Search</span>
          <kbd slot="trailing">âŒ˜K</kbd>
        </ui-button>

        <ui-nav class="nav-links" size="md" value={currentEntry?.path}>
          {[...groups.entries()].map(([groupName, entries]) => (
            <ui-nav-group>
              <ui-nav-group-header>
                <ui-icon name={groupIcons[groupName] || 'compass'}></ui-icon>
                {groupName}
              </ui-nav-group-header>
              {entries.map(e => (
                <ui-nav-item
                  value={e.path}
                  aria-current={currentPath === e.path ? 'page' : undefined}
                >
                  {e.title}
                </ui-nav-item>
              ))}
            </ui-nav-group>
          ))}
        </ui-nav>
      </ui-layout-sidebar-content>

      <ui-layout-sidebar-footer>
        <ui-layout-sidebar-trigger>
          <ui-icon name="user"></ui-icon>
          <span slot="label">User</span>
          <ui-icon name="caret-up-down" slot="trailing"></ui-icon>
          <ui-listbox popover="manual">
            <ui-option-group>
              <ui-option-group-header>Account</ui-option-group-header>
              <ui-option value="upgrade"><ui-icon name="sparkle"></ui-icon> Upgrade to Pro</ui-option>
              <ui-option value="account"><ui-icon name="gear"></ui-icon> Account</ui-option>
              <ui-option value="billing"><ui-icon name="credit-card"></ui-icon> Billing</ui-option>
              <ui-option value="notifications"><ui-icon name="bell"></ui-icon> Notifications</ui-option>
            </ui-option-group>
            <ui-option-group>
              <ui-option value="sign-out"><ui-icon name="sign-out"></ui-icon> Log out</ui-option>
            </ui-option-group>
          </ui-listbox>
        </ui-layout-sidebar-trigger>
      </ui-layout-sidebar-footer>
    </aside>

    <div>
      <ui-layout-breadcrumb>
        <ui-button
          variant="ghost"
          size="sm"
          slot="leading"
          aria-label="Toggle sidebar"
          id="sidebar-toggle"
        >
          <ui-icon name="sidebar-simple" size="md"></ui-icon>
        </ui-button>

        <ui-breadcrumb>
          {currentEntry && (
            <>
              <ui-breadcrumb-item>{currentEntry.group}</ui-breadcrumb-item>
              <ui-breadcrumb-item current>{currentEntry.title}</ui-breadcrumb-item>
            </>
          )}
        </ui-breadcrumb>

        <div slot="trailing" style="display:flex;align-items:center;gap:0.125rem">
          <ui-button variant="ghost" size="sm" aria-label="Toggle inspector" id="inspector-toggle">
            <ui-icon name="sliders-horizontal" size="md"></ui-icon>
          </ui-button>
          <ui-button variant="ghost" size="sm" aria-label="Toggle chat" id="chat-toggle">
            <ui-icon name="chat-dots" size="md"></ui-icon>
          </ui-button>
          <ui-button variant="ghost" size="sm" aria-label="Toggle source code" id="code-toggle" style="display:none">
            <ui-icon name="code" size="md"></ui-icon>
          </ui-button>
          <ui-button variant="ghost" size="sm" aria-label="Toggle color scheme" id="theme-toggle">
            <ui-icon name="moon" size="md"></ui-icon>
          </ui-button>
        </div>
      </ui-layout-breadcrumb>

      <ui-layout-canvas>
        <ui-layout-body>
          <slot />
        </ui-layout-body>
        <ui-layout-inspector>
          <div class="layout-resize-handle"></div>
        </ui-layout-inspector>
        <ui-layout-chat>
          <div class="layout-resize-handle"></div>
          <ui-chat size="sm">
            <ui-chat-content></ui-chat-content>
          </ui-chat>
        </ui-layout-chat>
      </ui-layout-canvas>
    </div>
  </ui-layout-sidebar>

  <!-- Command palette dialog -->
  <ui-dialog class="nav-cmd-dialog" id="nav-cmd-dialog">
    <ui-command>
      <ui-command-input>
        <ui-icon name="magnifying-glass"></ui-icon>
        <input type="text" placeholder="Search pages..." />
      </ui-command-input>
      <ui-command-list>
        {sitemap.map(entry => (
          <ui-command-item value={entry.path} keywords={entry.group}>
            {entry.title}
          </ui-command-item>
        ))}
      </ui-command-list>
      <ui-command-empty>No pages found.</ui-command-empty>
    </ui-command>
  </ui-dialog>

  <script>
    import '../scripts/layout.ts';
  </script>
</BaseLayout>
